<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GURILA BET | SYSTEM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* RESET E CORES GURILA (DARK) */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
        body { background-color: #0d1117; color: #e6edf3; padding-bottom: 50px; }
        
        /* PALETA GURILA */
        :root {
            --neon: #00ff88;
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --border: #30363d;
            --text-gray: #8b949e;
        }

        /* 1. HEADER (TOPO) */
        .header { 
            background-color: var(--bg-card); 
            padding: 12px 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid var(--neon); 
        }
        .brand { font-size: 20px; font-weight: 900; color: #fff; font-style: italic; letter-spacing: -1px; }
        .brand span { color: var(--neon); }
        .menu-icon { font-size: 20px; color: var(--neon); cursor: pointer; }

        /* 2. BARRA DE APOSTA (FIXA NO TOPO - ESTRUTURA SB99) */
        .bet-bar { 
            background: #000; padding: 10px; 
            display: flex; align-items: center; justify-content: space-between; 
            border-bottom: 1px solid var(--border); 
            position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .input-money { 
            background: var(--bg-card); border: 1px solid var(--border); 
            padding: 8px; width: 100px; border-radius: 4px; 
            font-size: 16px; color: var(--neon); font-weight: bold;
        }
        .return-info { text-align: center; font-size: 10px; color: var(--text-gray); line-height: 1.3; }
        .return-info b { display: block; font-size: 14px; color: #fff; }
        
        .btn-cupom { 
            background: var(--neon); color: #000; font-weight: 900; 
            padding: 8px 15px; border-radius: 4px; border: none; font-size: 12px;
            cursor: pointer; text-transform: uppercase;
        }
        .badge { background: #000; color: var(--neon); padding: 1px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px; }

        /* 3. NAVEGA√á√ÉO DATAS */
        .nav-dates { display: flex; background: var(--bg-dark); border-bottom: 1px solid var(--border); overflow-x: auto; }
        .nav-item { flex: 1; padding: 15px; text-align: center; font-size: 12px; font-weight: bold; color: var(--text-gray); cursor: pointer; border-bottom: 2px solid transparent; }
        .nav-item.active { color: var(--neon); border-bottom-color: var(--neon); background: var(--bg-card); }

        /* 4. LISTA SANFONA (ESTRUTURA SB99 / VISUAL GURILA) */
        .league-container { padding: 5px; }
        
        .league-btn {
            background: linear-gradient(90deg, #161b22, #0d1117);
            color: #fff;
            padding: 12px;
            margin-bottom: 5px;
            border: 1px solid var(--border);
            border-left: 4px solid var(--neon);
            border-radius: 4px;
            font-weight: bold; font-size: 12px; text-transform: uppercase;
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer;
        }
        .league-btn i { color: var(--neon); margin-right: 8px; }
        .league-btn .arrow { color: var(--text-gray); transition: 0.3s; }
        .league-btn.open .arrow { transform: rotate(180deg); color: var(--neon); }

        /* JOGOS DENTRO DA SANFONA */
        .league-games { display: none; margin-bottom: 5px; }
        .league-games.show { display: block; }

        .game-row { 
            background: var(--bg-card); border: 1px solid var(--border); 
            margin-bottom: -1px; padding: 10px; display: flex; flex-direction: column; gap: 8px; 
        }
        
        .game-info { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-gray); font-weight: bold; }
        .teams-names { font-size: 13px; font-weight: bold; color: #e6edf3; margin-bottom: 5px; }

        /* BOT√ïES QUADRADOS (SB99 Style) */
        .odds-row { display: flex; gap: 4px; }
        .odd-sq { 
            flex: 1; background: #0d1117; border: 1px solid var(--border); 
            padding: 10px 5px; text-align: center; border-radius: 4px; cursor: pointer; 
            transition: 0.2s;
        }
        .odd-sq span { display: block; font-size: 9px; color: var(--text-gray); font-weight: bold; margin-bottom: 2px; }
        .odd-sq b { display: block; font-size: 13px; color: var(--neon); }
        
        .odd-sq.active { background: var(--neon); border-color: var(--neon); } 
        .odd-sq.active span { color: #000; opacity: 0.7; }
        .odd-sq.active b { color: #000; }

        .btn-more { 
            width: 40px; background: #21262d; color: var(--text-gray); 
            display: flex; align-items: center; justify-content: center; 
            border-radius: 4px; font-size: 10px; font-weight: bold; border: 1px solid var(--border);
        }

        /* MENU LATERAL (DARK) */
        .sidebar { position: fixed; top: 0; right: -260px; width: 260px; height: 100%; background: var(--bg-card); z-index: 200; transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.8); padding: 20px; border-left: 1px solid var(--border); }
        .sidebar.open { right: 0; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 150; display: none; }
        .overlay.open { display: block; }

        .form-control { width: 100%; padding: 12px; background: #0d1117; border: 1px solid var(--border); color: #fff; border-radius: 4px; margin-bottom: 10px; font-size: 14px; outline: none; }
        .form-control:focus { border-color: var(--neon); }
        
        .btn-action { width: 100%; padding: 12px; background: var(--neon); color: #000; border: none; border-radius: 4px; font-weight: 900; cursor: pointer; text-transform: uppercase; margin-top: 5px; }
        .btn-outline { background: transparent; border: 1px solid var(--neon); color: var(--neon); margin-top: 10px; }

        /* MODAL CUPOM (DARK) */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal-box { background: var(--bg-card); width: 90%; max-width: 400px; border-radius: 8px; border: 1px solid var(--border); overflow: hidden; }
        .modal-header { background: #0d1117; padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; color: #fff; font-weight: bold; }
        .modal-body { padding: 15px; max-height: 60vh; overflow-y: auto; }
        
        .cupom-item { background: #0d1117; border: 1px solid var(--border); padding: 10px; margin-bottom: 8px; border-left: 3px solid var(--neon); display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #fff; }
        .cupom-del { color: #ff4d4d; padding: 5px; cursor: pointer; }

    </style>
</head>
<body>

    <div class="header">
        <div class="brand">GURILA<span>BET</span> ü¶ç</div>
        <i class="fas fa-bars menu-icon" onclick="toggleMenu()"></i>
    </div>

    <div class="bet-bar">
        <div>
            <label style="font-size:9px; color:#888; display:block;">SUA APOSTA</label>
            <input type="number" id="valor-topo" class="input-money" placeholder="0,00" oninput="atualizarCalculo()">
        </div>
        <div class="return-info">
            RETORNO<br>
            <b id="retorno-topo">R$ 0,00</b>
        </div>
        <button class="btn-cupom" onclick="finalizarZap()">
            BILHETE <span class="badge" id="qtd-cupom">0</span>
        </button>
    </div>

    <div class="nav-dates">
        <div class="nav-item active" onclick="loadJogos('hoje', this)">HOJE</div>
        <div class="nav-item" onclick="loadJogos('amanha', this)">AMANH√É</div>
        <div class="nav-item" onclick="loadJogos('depois', this)">S√ÅBADO</div>
    </div>

    <div id="container-ligas" class="league-container">
        <div style="text-align:center; padding:40px; color:#555; font-size:12px; font-weight:bold;">
            <i class="fas fa-circle-notch fa-spin"></i> CARREGANDO SISTEMA...
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="toggleMenu()"></div>
    <div class="sidebar" id="sidebar">
        <h3 style="margin-bottom:20px; color:#fff; border-bottom:1px solid #333; padding-bottom:10px;">MENU</h3>
        
        <div id="form-login">
            <input type="email" id="email" class="form-control" placeholder="Email">
            <input type="password" id="senha" class="form-control" placeholder="Senha">
            <button class="btn-action" onclick="fazerLogin()">ENTRAR</button>
            <button class="btn-action btn-outline" onclick="mostrarCadastro()">CRIAR CONTA</button>
        </div>

        <div id="form-cadastro" style="display:none;">
            <input type="text" id="cad-nome" class="form-control" placeholder="Nome Completo">
            <input type="email" id="cad-email" class="form-control" placeholder="Email">
            <input type="password" id="cad-senha" class="form-control" placeholder="Senha">
            <button class="btn-action" onclick="fazerCadastro()">CADASTRAR</button>
            <button class="btn-action btn-outline" onclick="mostrarLogin()">VOLTAR</button>
        </div>

        <div id="user-logged" style="display:none;">
            <p style="color:#fff;">Ol√°, <b id="user-name" style="color:var(--neon);">Admin</b></p>
            <button class="btn-action btn-outline" style="border-color:#ff4d4d; color:#ff4d4d;" onclick="logout()">SAIR</button>
        </div>
    </div>

    <div id="modal-cupom" class="modal">
        <div class="modal-box">
            <div class="modal-header">
                <span>CONFIRMAR APOSTA</span>
                <span onclick="fecharModal()" style="cursor:pointer; color:#888;">X</span>
            </div>
            <div class="modal-body">
                <div id="lista-cupom"></div>
                
                <div style="margin-top:15px;">
                    <label style="font-size:10px; color:#888; font-weight:bold;">CLIENTE</label>
                    <input type="text" id="cliente" class="form-control" placeholder="Nome do Apostador">
                </div>

                <div style="background:#000; padding:15px; border:1px solid #333; border-radius:4px; text-align:center; margin-top:10px;">
                    <small style="color:#888;">RETORNO TOTAL</small><br>
                    <b id="retorno-final" style="font-size:20px; color:var(--neon);">R$ 0,00</b>
                </div>

                <button onclick="enviarAposta()" id="btn-finalizar" class="btn-action" style="margin-top:15px;">GERAR BILHETE</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const API_URL = 'https://gurilabet-v2-production.up.railway.app'; 
        const ZAP_NUMERO = "5561995478204"; 

        let CARRINHO = [];
        let USUARIO = JSON.parse(localStorage.getItem('gb_user'));

        window.onload = () => {
            carregarJogos();
            verificarLogin();
        };

        // --- DADOS ---
        async function carregarJogos() {
            try {
                // Backend V26 (que busca ESPN/Backup)
                const res = await fetch(`${API_URL}/api/jogos`);
                const jogos = await res.json();
                renderizarLigas(jogos);
            } catch (e) {
                document.getElementById('container-ligas').innerHTML = `<div style="text-align:center; padding:40px; color:red;">ERRO DE CONEX√ÉO</div>`;
            }
        }

        function renderizarLigas(jogos) {
            const grupos = {};
            jogos.forEach(j => {
                if(!grupos[j.liga]) grupos[j.liga] = [];
                grupos[j.liga].push(j);
            });

            let html = '';
            for(let liga in grupos) {
                // HEADER DA SANFONA
                html += `
                <div class="league-btn" onclick="toggleLiga('liga-${liga.replace(/[^a-zA-Z0-9]/g, '')}')">
                    <span><i class="fas fa-trophy"></i> ${liga}</span>
                    <i class="fas fa-chevron-down arrow"></i>
                </div>
                
                <div id="liga-${liga.replace(/[^a-zA-Z0-9]/g, '')}" class="league-games">
                `;

                grupos[liga].forEach(j => {
                    let hora = new Date(j.data).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                    
                    // CARD DO JOGO (Dark + Bot√µes Quadrados)
                    html += `
                    <div class="game-row">
                        <div class="game-info">
                            <span>${hora} &nbsp; | &nbsp; <span style="color:var(--neon)">${j.status}</span></span>
                            <span>ID: ${j.id}</span>
                        </div>
                        <div class="teams-names">
                            ${j.home.name} <span style="color:#666">x</span> ${j.away.name}
                        </div>
                        <div class="odds-row">
                            <div class="odd-sq" onclick="addAposta(this, ${j.id}, '1', ${j.odds.casa}, '${j.home.name} x ${j.away.name}')">
                                <span>CASA</span><b>${j.odds.casa}</b>
                            </div>
                            <div class="odd-sq" onclick="addAposta(this, ${j.id}, 'X', ${j.odds.empate}, '${j.home.name} x ${j.away.name}')">
                                <span>EMPATE</span><b>${j.odds.empate}</b>
                            </div>
                            <div class="odd-sq" onclick="addAposta(this, ${j.id}, '2', ${j.odds.fora}, '${j.home.name} x ${j.away.name}')">
                                <span>FORA</span><b>${j.odds.fora}</b>
                            </div>
                            <div class="btn-more"><i class="fas fa-plus"></i></div>
                        </div>
                    </div>`;
                });

                html += `</div>`; 
            }
            document.getElementById('container-ligas').innerHTML = html;
        }

        function toggleLiga(id) {
            const el = document.getElementById(id);
            el.classList.toggle('show');
            el.previousElementSibling.classList.toggle('open');
        }

        // --- APOSTA ---
        function addAposta(el, id, opcao, odd, nome) {
            const pai = el.parentElement;
            pai.querySelectorAll('.odd-sq').forEach(b => b.classList.remove('active'));

            const idx = CARRINHO.findIndex(i => i.id === id);
            if(idx !== -1) {
                if(CARRINHO[idx].opcao === opcao) {
                    CARRINHO.splice(idx, 1);
                    atualizarTopo();
                    return;
                }
                CARRINHO.splice(idx, 1);
            }

            CARRINHO.push({ id, opcao, odd, nome });
            el.classList.add('active'); // Fica Verde Neon
            atualizarTopo();
        }

        function atualizarTopo() {
            const qtd = CARRINHO.length;
            document.getElementById('qtd-cupom').innerText = qtd;
            
            let oddsTotal = CARRINHO.reduce((acc, i) => acc * parseFloat(i.odd), 1);
            if(qtd === 0) oddsTotal = 0;

            const valor = parseFloat(document.getElementById('valor-topo').value) || 0;
            const retorno = valor * oddsTotal;

            document.getElementById('retorno-topo').innerText = `R$ ${retorno.toFixed(2)}`;
            document.getElementById('retorno-final').innerText = `R$ ${retorno.toFixed(2)}`;
        }

        function atualizarCalculo() { atualizarTopo(); }

        function finalizarZap() {
            const valor = parseFloat(document.getElementById('valor-topo').value);
            if(!valor || valor <= 0) return alert("Digite o valor da aposta l√° em cima!");
            if(CARRINHO.length === 0) return alert("Selecione pelo menos 1 jogo!");
            
            // Abre Modal para por nome
            document.getElementById('modal-cupom').style.display = 'flex';
            
            // Renderiza lista
            let html = '';
            CARRINHO.forEach((item, i) => {
                html += `<div class="cupom-item">
                    <div><b>${item.nome}</b><br>${item.opcao} (${item.odd})</div>
                    <div class="cupom-del" onclick="remove(${i})">X</div>
                </div>`;
            });
            document.getElementById('lista-cupom').innerHTML = html;
        }

        function remove(i) {
            CARRINHO.splice(i, 1);
            finalizarZap(); // Re-renderiza
            atualizarTopo();
            if(CARRINHO.length === 0) fecharModal();
        }

        function fecharModal() { document.getElementById('modal-cupom').style.display = 'none'; }

        async function enviarAposta() {
            const cliente = document.getElementById('cliente').value;
            const valor = parseFloat(document.getElementById('valor-topo').value);
            
            if(!cliente) return alert("Digite o nome do cliente");

            const btn = document.getElementById('btn-finalizar');
            btn.innerText = "‚è≥ GERANDO..."; btn.disabled = true;

            // Calcula Odd Final
            let oddTotal = CARRINHO.reduce((acc, i) => acc * parseFloat(i.odd), 1);
            
            try {
                const res = await fetch(`${API_URL}/api/finalizar`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ usuario_id: 1, valor: valor, apostas: CARRINHO, odd_total: oddTotal })
                });
                const d = await res.json();

                if(d.sucesso) {
                    let msg = `ü¶ç *GURILA BET* ü¶ç\n\n`;
                    msg += `üë§ Apostador: *${cliente}*\n`;
                    msg += `üìÉ Bilhete: *${d.codigo}*\n`;
                    msg += `-------------------------\n`;
                    CARRINHO.forEach(c => msg += `‚öΩ ${c.nome}\nüéØ ${c.opcao} (Odd: ${c.odd})\n\n`);
                    msg += `-------------------------\n`;
                    msg += `üí∞ Valor: R$ ${valor.toFixed(2)}\n`;
                    msg += `üèÜ Retorno: R$ ${d.retorno}\n`;
                    
                    window.open(`https://wa.me/${ZAP_NUMERO}?text=${encodeURIComponent(msg)}`, '_blank');
                    
                    CARRINHO = []; atualizarTopo(); fecharModal();
                    document.querySelectorAll('.odd-sq.active').forEach(b => b.classList.remove('active'));
                } else {
                    alert("Erro: " + d.erro);
                }
            } catch(e) { alert("Erro de conex√£o"); }
            
            btn.innerText = "GERAR BILHETE"; btn.disabled = false;
        }

        // --- MENU/LOGIN ---
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
        }
        function mostrarCadastro() {
            document.getElementById('form-login').style.display = 'none';
            document.getElementById('form-cadastro').style.display = 'block';
        }
        function mostrarLogin() {
            document.getElementById('form-cadastro').style.display = 'none';
            document.getElementById('form-login').style.display = 'block';
        }
        
        function verificarLogin() {
            if(USUARIO) {
                document.getElementById('form-login').style.display = 'none';
                document.getElementById('user-logged').style.display = 'block';
                document.getElementById('user-name').innerText = USUARIO.nome;
            }
        }

        async function fazerLogin() {
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;
            try {
                const res = await fetch(`${API_URL}/api/login`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, senha})});
                const d = await res.json();
                if(d.sucesso) {
                    USUARIO = d.usuario; localStorage.setItem('gb_user', JSON.stringify(USUARIO));
                    verificarLogin();
                } else alert("Erro Login");
            } catch(e) { alert("Erro"); }
        }

        async function fazerCadastro() {
            const nome = document.getElementById('cad-nome').value;
            const email = document.getElementById('cad-email').value;
            const senha = document.getElementById('cad-senha').value;
            try {
                const res = await fetch(`${API_URL}/api/cadastro`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({nome, email, senha})});
                const d = await res.json();
                if(d.sucesso) { alert("Cadastrado!"); mostrarLogin(); } else alert("Erro");
            } catch(e) { alert("Erro"); }
        }

        function logout() { localStorage.removeItem('gb_user'); location.reload(); }

    </script>
</body>
</html>
