<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GURILA BET | PROFESSIONAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #060a0d; color: #fff; font-family: 'Inter', sans-serif; }
        
        /* Headers e Cards */
        .league-header { background: #12171d; border-left: 4px solid #00ff88; padding: 12px; font-size: 11px; font-weight: 900; text-transform: uppercase; display: flex; align-items: center; gap: 10px; color: #94a3b8; }
        .league-top { border-left: 4px solid #fbbf24; background: #1e1b0b; color: #fbbf24; }
        .match-card { background: #0f141a; border-bottom: 1px solid #1e262f; padding: 15px; display: flex; align-items: center; justify-content: space-between; position: relative; }
        .odd-btn { background: #1c242c; border: 1px solid #2d3741; border-radius: 6px; width: 50px; height: 42px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; color: #00ff88; transition: 0.2s; cursor: pointer; }
        .odd-btn:hover { background: #2d3741; border-color: #00ff88; }
        .odd-active { background: #00ff88 !important; color: #000 !important; border-color: #00ff88 !important; }
        
        /* Navega√ß√£o */
        .date-btn { flex: 1; padding: 10px; text-align: center; font-size: 12px; font-weight: bold; color: #94a3b8; cursor: pointer; transition: 0.3s; background: #11171e; }
        .date-btn.active { background: linear-gradient(90deg, #10b981 0%, #059669 100%); color: #fff; border-bottom: 2px solid #00ff88; }
        .live-pulse { animation: pulseRed 1.5s infinite; color: #ef4444; }
        @keyframes pulseRed { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        /* √çcones e Busca */
        .sport-icon { display: flex; flex-direction: column; align-items: center; gap: 5px; color: #94a3b8; width: 60px; }
        .sport-icon i { font-size: 20px; }
        .sport-icon span { font-size: 9px; font-weight: bold; }
        .sport-active { color: #00ff88; }
        .sport-active i { color: #fff; }
        .search-container { padding: 10px; background: #0b0f13; position: relative; }
        .search-input { width: 100%; background: #161b22; border: 1px solid #2d3741; padding: 10px 10px 10px 40px; border-radius: 8px; color: white; outline: none; font-size: 12px; font-weight: bold; }
        .search-icon { position: absolute; left: 22px; top: 22px; color: #94a3b8; font-size: 14px; }
        
        /* Mercados e Bot√µes */
        .camp-btn { background: #11171e; border: 1px solid #2d3741; padding: 8px 15px; border-radius: 50px; white-space: nowrap; font-size: 10px; font-weight: 900; color: #94a3b8; transition: 0.2s; }
        .camp-btn.active { background: #00ff88; color: #000; border-color: #00ff88; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .market-box { background: #161b22; border: 1px solid #2d3741; border-radius: 8px; padding: 10px; margin-bottom: 10px; }
        .market-title { font-size: 10px; font-weight: 900; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px; border-bottom: 1px solid #2d3741; padding-bottom: 4px; }
        .market-btn { background: #0d1117; color: #fff; padding: 12px; border-radius: 6px; text-align: center; font-size: 11px; font-bold; border: 1px solid #30363d; display: flex; justify-content: space-between; cursor: pointer; transition: 0.2s; }
        .market-btn:hover { border-color: #00ff88; }
        .market-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .market-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }

        /* CUPOM NOVO ESTILO */
        .cupom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #11171e; border-top: 1px solid #00ff88; padding: 15px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; box-shadow: 0 -5px 30px rgba(0,0,0,0.9); }
        
        .bet-item { background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .bet-info h4 { font-size: 11px; font-weight: 900; color: #fff; text-transform: uppercase; }
        .bet-info p { font-size: 10px; color: #00ff88; font-weight: bold; }
        .bet-delete { color: #ef4444; background: rgba(239, 68, 68, 0.1); width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; }
        
        .quick-val-btn { background: #1f2937; border: 1px solid #374151; color: #9ca3af; font-size: 10px; font-weight: bold; padding: 8px; border-radius: 6px; transition: 0.2s; }
        .quick-val-btn:hover, .quick-val-btn:active { background: #00ff88; color: #000; border-color: #00ff88; }
        
        .input-group label { display: block; font-size: 10px; color: #9ca3af; font-weight: bold; margin-bottom: 4px; uppercase; }
        .input-dark { width: 100%; background: #0d1117; border: 1px solid #30363d; padding: 10px; border-radius: 8px; color: white; outline: none; font-size: 12px; }
        .input-dark:focus { border-color: #00ff88; }
        
        .max-win { color: #ffd700 !important; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
    </style>
</head>
<body class="pb-24 bg-[#060a0d]">

    <header class="p-4 bg-[#0b0f13] border-b border-gray-800 flex justify-between items-center sticky top-0 z-50">
        <h1 class="text-2xl font-black italic uppercase text-white tracking-tighter">Gurila<span class="text-green-500">Bet</span> ü¶ç</h1>
        <div id="user-area">
            </div>
    </header>

    <div class="bg-[#0f141a] py-3 border-b border-gray-800 flex justify-around overflow-x-auto no-scrollbar">
        <div class="sport-icon sport-active"><i class="fas fa-futbol"></i><span>FUTEBOL</span></div>
        <div class="sport-icon"><i class="fas fa-basketball-ball"></i><span>BASQUETE</span></div>
        <div class="sport-icon"><i class="fas fa-hand-rock"></i><span>LUTA</span></div>
        <div class="sport-icon"><i class="fas fa-table-tennis"></i><span>T√äNIS</span></div>
        <div class="sport-icon"><i class="fas fa-gamepad"></i><span>E-SPORTS</span></div>
    </div>

    <div class="flex border-b border-gray-800 bg-[#0b0f13]">
        <div id="btn-aovivo" onclick="mudarData('aovivo')" class="date-btn flex items-center justify-center gap-1">AO VIVO <span class="live-pulse">‚óè</span></div>
        <div id="btn-hoje" onclick="mudarData('hoje')" class="date-btn active">HOJE</div>
        <div id="btn-amanha" onclick="mudarData('amanha')" class="date-btn">AMANH√É</div>
        <div id="btn-depois" onclick="mudarData('depois')" class="date-btn">DIA 16/01</div>
    </div>
    
    <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" placeholder="Buscar Time ou Campeonato..." onkeyup="filtrarBusca(this.value)">
    </div>

    <div class="p-3 bg-[#0b0f13] overflow-x-auto no-scrollbar flex gap-2" id="menu-campeonatos">
        <button onclick="filtrarLiga('Todos')" class="camp-btn active uppercase">Todos</button>
    </div>

    <main id="container-jogos" class="max-w-3xl mx-auto p-2 pb-40">
        <div class="text-center py-20 text-gray-600 animate-pulse font-bold uppercase italic text-xs">Carregando Jogos...</div>
    </main>
    
    <footer class="text-center py-4 bg-[#0b0f13] border-t border-gray-800 mb-20">
         <button onclick="document.getElementById('modal-validador').classList.remove('hidden')" class="text-[10px] text-gray-600 font-bold uppercase hover:text-green-500 transition">
             <i class="fas fa-shield-alt mr-1"></i> Validar Bilhete
         </button>
         <p class="text-[9px] text-gray-700 mt-2">¬© 2026 Gurila Bet. Todos os direitos reservados.</p>
    </footer>

    <div id="cupom-bar" class="cupom-bar hidden">
        <div class="flex flex-col">
            <span class="text-[10px] text-gray-400 font-bold uppercase">Boletim (<span id="qtd-apostas-bar">0</span>/10)</span>
            <div class="text-white font-black text-sm">Odd: <span id="odd-total" class="text-green-500">1.00</span></div>
        </div>
        <button onclick="abrirCupomDetalhado()" class="bg-green-600 text-black font-black uppercase italic px-6 py-2 rounded-lg text-xs hover:bg-white transition">Abrir Bilhete</button>
    </div>

    <div id="modal-cupom" class="fixed inset-0 bg-black/95 z-[700] hidden flex-col justify-end">
        <div class="bg-[#161b22] rounded-t-3xl border-t border-gray-800 h-[90vh] flex flex-col shadow-2xl">
            
            <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-[#11171e] rounded-t-3xl">
                <div>
                    <h3 class="text-sm font-black uppercase text-white">Cupom de Aposta</h3>
                    <span class="text-[10px] text-gray-500 font-bold"><span id="cupom-count">0</span> Sele√ß√µes</span>
                </div>
                <button onclick="document.getElementById('modal-cupom').classList.add('hidden')" class="w-8 h-8 bg-gray-800 rounded-full text-white font-bold">&times;</button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                
                <div id="lista-apostas"></div>

                <div class="grid grid-cols-5 gap-2 mb-2">
                    <button onclick="definirValor(2)" class="quick-val-btn">R$ 2</button>
                    <button onclick="definirValor(5)" class="quick-val-btn">R$ 5</button>
                    <button onclick="definirValor(10)" class="quick-val-btn">R$ 10</button>
                    <button onclick="definirValor(20)" class="quick-val-btn">R$ 20</button>
                    <button onclick="definirValor(50)" class="quick-val-btn">R$ 50</button>
                </div>

                <div class="space-y-3 bg-[#0d1117] p-3 rounded-lg border border-[#30363d]">
                    <div class="input-group">
                        <label>Valor da Aposta (R$)*</label>
                        <input type="number" id="valor-aposta" class="input-dark text-green-500 font-bold text-lg" placeholder="0.00" oninput="calcularRetorno()">
                    </div>
                    <div class="input-group">
                        <label>Seu Nome*</label>
                        <input type="text" id="cliente-nome" class="input-dark" placeholder="Digite seu nome">
                    </div>
                    <div class="input-group">
                        <label>Telefone (Opcional)</label>
                        <input type="tel" id="cliente-tel" class="input-dark" placeholder="(00) 00000-0000">
                    </div>
                </div>

                <div class="bg-[#11171e] p-4 rounded-lg border border-gray-800 space-y-2">
                    <div class="flex justify-between text-xs text-gray-400 font-bold">
                        <span>Cota√ß√£o Total:</span>
                        <span id="odd-final" class="text-white">1.00</span>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400 font-bold">
                        <span>Retorno Bruto:</span>
                        <span id="retorno-bruto" class="text-white">R$ 0.00</span>
                    </div>
                    <div class="flex justify-between text-sm font-black border-t border-gray-700 pt-2 mt-1">
                        <span class="text-white">LUCRO POTENCIAL:</span>
                        <span id="retorno-liquido" class="text-green-500 text-lg">R$ 0.00</span>
                    </div>
                    <div id="aviso-limite" class="text-[9px] text-red-500 font-bold uppercase text-right hidden">Limite da Banca (R$ 2.500)</div>
                </div>

            </div>

            <div class="p-4 bg-[#11171e] border-t border-gray-800 grid grid-cols-2 gap-3">
                <button onclick="limparCupom()" class="bg-red-900/50 text-red-500 font-bold p-3 rounded-xl uppercase text-xs border border-red-900 hover:bg-red-900 hover:text-white transition">Limpar</button>
                <button onclick="enviarAposta()" class="bg-green-600 text-black font-black p-3 rounded-xl uppercase text-xs hover:bg-white transition shadow-[0_0_15px_rgba(0,255,136,0.4)]">Gerar Pr√©-Bilhete ü¶ç</button>
            </div>
        </div>
    </div>

    <div id="modal-extras" class="fixed inset-0 bg-[#060a0d] z-[600] hidden flex-col">
        <header class="p-4 bg-[#0b0f13] border-b border-gray-800 flex justify-between items-center sticky top-0">
            <div><h3 id="modal-titulo" class="text-xs font-black uppercase text-white"></h3><span class="text-[10px] text-green-500 font-bold uppercase">Mercados</span></div>
            <button onclick="document.getElementById('modal-extras').classList.add('hidden')" class="w-8 h-8 bg-gray-800 rounded-full text-white font-bold">&times;</button>
        </header>
        <div id="modal-corpo" class="p-3 overflow-y-auto pb-24"></div>
    </div>
    
    <div id="modal-validador" class="fixed inset-0 bg-black/95 z-[900] hidden flex items-center justify-center p-4">
        <div class="bg-[#161b22] p-6 rounded-2xl w-full max-w-sm border border-gray-800 text-center">
            <h2 class="text-lg font-black text-green-500 uppercase mb-4">Validar Bilhete üëÆ‚Äç‚ôÇÔ∏è</h2>
            <input id="input-codigo" type="text" placeholder="C√≥digo (Ex: GB123456)" class="w-full bg-black border border-gray-700 p-3 rounded-lg mb-4 text-white text-center font-bold uppercase outline-none">
            <button onclick="validarBilhete()" class="w-full bg-green-600 text-black font-bold p-3 rounded-lg uppercase">Verificar</button>
            <div id="resultado-validacao" class="mt-4 hidden bg-black p-3 rounded text-left text-xs border border-gray-700"></div>
            <button onclick="document.getElementById('modal-validador').classList.add('hidden')" class="mt-4 text-xs text-gray-500 underline">Fechar</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://gurilabet-v2-production.up.railway.app'; 
        let todosJogos = [];
        let jogosExibidos = [];
        let carrinho = [];
        let ligaAtiva = 'Todos';
        let modoAtual = 'hoje';
        let dataAtiva = new Date().toISOString().split('T')[0];
        let usuario = JSON.parse(localStorage.getItem('gurila_user')); // Pode ser null agora, usamos input direto
        
        const LIMITE_JOGOS = 10;
        const LIMITE_GANHO = 2500.00;
        const LIGAS_TOP = ['Serie A', 'Serie B', 'Premier League', 'La Liga', 'Bundesliga', 'Ligue 1', 'UEFA Champions League', 'Copa Libertadores'];

        const hoje = new Date();
        const amanha = new Date(hoje); amanha.setDate(hoje.getDate() + 1);
        const depois = new Date(hoje); depois.setDate(hoje.getDate() + 2);
        
        document.getElementById('btn-depois').innerText = `DIA ${depois.getDate()}/${depois.getMonth()+1}`;

        // Se j√° tiver usu√°rio salvo, preenche o input automaticamente
        if(usuario && usuario.nome) {
            document.getElementById('user-area').innerHTML = `<span class="text-xs font-bold text-green-500 uppercase">${usuario.nome}</span>`;
        }

        function mudarData(tipo) {
            document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
            modoAtual = tipo;
            if(tipo === 'aovivo') { document.getElementById('btn-aovivo').classList.add('active'); }
            else if(tipo === 'hoje') { document.getElementById('btn-hoje').classList.add('active'); dataAtiva = hoje.toISOString().split('T')[0]; }
            else if (tipo === 'amanha') { document.getElementById('btn-amanha').classList.add('active'); dataAtiva = amanha.toISOString().split('T')[0]; }
            else { document.getElementById('btn-depois').classList.add('active'); dataAtiva = depois.toISOString().split('T')[0]; }
            carregar();
        }

        function traduzir(texto) {
            const dic = { 'Brazil': 'Brasil', 'England': 'Inglaterra', 'Spain': 'Espanha', 'World': 'Mundial', 'France': 'Fran√ßa', 'Germany': 'Alemanha', 'Italy': 'It√°lia' };
            return dic[texto] || texto;
        }

        async function carregar() {
            document.getElementById('container-jogos').innerHTML = "<div class='text-center py-20 text-gray-600 animate-pulse font-bold uppercase italic text-xs'>Buscando Jogos...</div>";
            try {
                let url = `${API_URL}/api/jogos`;
                if (modoAtual === 'aovivo') url += `?aovivo=true`; else url += `?data=${dataAtiva}`;

                const res = await fetch(url);
                todosJogos = await res.json();
                jogosExibidos = todosJogos;
                
                if(todosJogos.length === 0) { document.getElementById('container-jogos').innerHTML = "<div class='text-center py-20 text-gray-500 font-bold'>Nenhum jogo dispon√≠vel.</div>"; return; }
                renderizarMenuLigas();
                renderizarVitrine();
            } catch (e) { document.getElementById('container-jogos').innerHTML = "<p class='text-center py-20 text-red-500'>Erro Conex√£o</p>"; }
        }

        function filtrarBusca(termo) {
            if(!termo) { jogosExibidos = todosJogos; }
            else {
                const t = termo.toLowerCase();
                jogosExibidos = todosJogos.filter(j => j.home.name.toLowerCase().includes(t) || j.away.name.toLowerCase().includes(t) || j.liga.toLowerCase().includes(t));
            }
            renderizarVitrine();
        }

        function renderizarMenuLigas() {
            const paises = [...new Set(todosJogos.map(j => traduzir(j.pais)))];
            let html = `<button onclick="filtrarLiga('Todos')" class="camp-btn ${ligaAtiva === 'Todos' ? 'active' : ''}">TODOS</button>`;
            paises.forEach(p => { html += `<button onclick="filtrarLiga('${p}')" class="camp-btn ${traduzir(ligaAtiva) === p ? 'active' : ''}">${p.toUpperCase()}</button>`; });
            document.getElementById('menu-campeonatos').innerHTML = html;
        }

        function filtrarLiga(liga) { ligaAtiva = liga; renderizarMenuLigas(); renderizarVitrine(); }

        function renderizarVitrine() {
            let filtrados = ligaAtiva === 'Todos' ? jogosExibidos : jogosExibidos.filter(j => traduzir(j.pais) === ligaAtiva);
            const gruposTop = {}; const gruposNormal = {};

            filtrados.forEach(j => {
                const chave = `${traduzir(j.pais)} - ${j.liga}`;
                if (LIGAS_TOP.some(top => j.liga.includes(top))) { if(!gruposTop[chave]) gruposTop[chave] = []; gruposTop[chave].push(j); }
                else { if(!gruposNormal[chave]) gruposNormal[chave] = []; gruposNormal[chave].push(j); }
            });

            let html = '';
            const renderGrupo = (listaGrupos, isTop) => {
                for(let liga in listaGrupos) {
                    const estiloHeader = isTop ? 'league-header league-top' : 'league-header';
                    const icone = isTop ? '<i class="fas fa-star text-yellow-500 mr-1"></i>' : '';
                    html += `<div class="mb-4 rounded-lg overflow-hidden border border-[#1e262f]"><div class="${estiloHeader}"><img src="${listaGrupos[liga][0].logo_liga}" class="w-5 h-5 object-contain"><span>${icone}${liga}</span></div>`;
                    listaGrupos[liga].forEach(j => {
                        const dt = new Date(j.data);
                        let infoTempo = ['1H','2H','HT'].includes(j.status) ? `<span class="text-red-500 font-black animate-pulse">${j.status}</span>` : `${dt.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})}<br><span class="text-white text-xs font-black">${dt.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'})}</span>`;
                        html += `<div class="match-card ${!j.ativo ? 'match-locked' : ''}">
                            ${!j.ativo ? '<i class="fas fa-lock lock-icon"></i>' : ''}
                            <div class="text-[10px] text-gray-500 font-bold w-12 text-center leading-tight">${infoTempo}</div>
                            <div class="flex-1 px-4 border-l border-gray-800 ml-2">
                                <div class="flex items-center gap-2 font-bold text-[10px] mb-2 uppercase text-gray-200"><img src="${j.home.logo}" class="w-4 h-4"> ${j.home.name}</div>
                                <div class="flex items-center gap-2 font-bold text-[10px] uppercase text-gray-200"><img src="${j.away.logo}" class="w-4 h-4"> ${j.away.name}</div>
                            </div>
                            <div class="flex gap-1 items-center">
                                <button onclick="addAposta(this, ${j.id}, 'Resultado', '1', ${j.odds.casa}, '${j.home.name} x ${j.away.name}')" class="odd-btn"><span class="text-[6px] text-gray-500 mb-0.5">1</span>${j.odds.casa}</button>
                                <button onclick="addAposta(this, ${j.id}, 'Resultado', 'X', ${j.odds.empate}, '${j.home.name} x ${j.away.name}')" class="odd-btn"><span class="text-[6px] text-gray-500 mb-0.5">X</span>${j.odds.empate}</button>
                                <button onclick="addAposta(this, ${j.id}, 'Resultado', '2', ${j.odds.fora}, '${j.home.name} x ${j.away.name}')" class="odd-btn"><span class="text-[6px] text-gray-500 mb-0.5">2</span>${j.odds.fora}</button>
                                <button onclick="abrirMercados(${j.id})" class="w-8 h-10 bg-[#2d3741] hover:bg-green-600 hover:text-black rounded-lg text-white font-black text-xs ml-1 transition flex items-center justify-center">+45</button>
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                }
            };
            renderGrupo(gruposTop, true); renderGrupo(gruposNormal, false);
            document.getElementById('container-jogos').innerHTML = html || "<div class='text-center py-10 text-gray-500'>Nenhum jogo encontrado.</div>";
        }

        // --- L√ìGICA DE CUPOM (ATUALIZADA PARA O NOVO DESIGN) ---
        function addAposta(el, id, mercado, opcao, odd, nome) {
            if (odd == 0 || odd == "Bloq") return;
            document.querySelectorAll('.odd-active').forEach(btn => { if(btn.getAttribute('onclick').includes(`, ${id},`)) btn.classList.remove('odd-active'); });
            
            const jaExiste = carrinho.find(i => i.id === id && i.opcao === opcao);
            if(jaExiste) { carrinho = carrinho.filter(i => i.id !== id); atualizarBarraCupom(); return; }

            const jaTinhaJogo = carrinho.some(i => i.id === id);
            if (!jaTinhaJogo && carrinho.length >= LIMITE_JOGOS) { alert(`Limite de ${LIMITE_JOGOS} jogos.`); return; }

            carrinho = carrinho.filter(i => i.id !== id);
            if(el) el.classList.add('odd-active');
            carrinho.push({ id, mercado, opcao, odd, nome });
            atualizarBarraCupom();
        }

        function removerAposta(index, id) {
            // Remove do array
            carrinho.splice(index, 1);
            // Remove visual do bot√£o ativo na vitrine
            document.querySelectorAll('.odd-active').forEach(btn => { 
                if(btn.getAttribute('onclick').includes(`, ${id},`)) btn.classList.remove('odd-active'); 
            });
            abrirCupomDetalhado(); // Re-renderiza o modal
            atualizarBarraCupom(); // Atualiza barra inferior
        }

        function atualizarBarraCupom() {
            const qtd = carrinho.length;
            if(qtd > 0) { 
                document.getElementById('cupom-bar').classList.remove('hidden'); 
                document.getElementById('qtd-apostas-bar').innerText = qtd; 
                document.getElementById('cupom-count').innerText = qtd;
                const oddTotal = carrinho.reduce((acc, item) => acc * parseFloat(item.odd), 1).toFixed(2); 
                document.getElementById('odd-total').innerText = oddTotal; 
            } else { 
                document.getElementById('cupom-bar').classList.add('hidden'); 
                document.getElementById('modal-cupom').classList.add('hidden'); // Fecha modal se esvaziar
            }
        }

        function abrirCupomDetalhado() {
            const lista = document.getElementById('lista-apostas'); 
            lista.innerHTML = '';
            
            if(carrinho.length === 0) {
                document.getElementById('modal-cupom').classList.add('hidden');
                return;
            }

            carrinho.forEach((item, index) => { 
                lista.innerHTML += `
                <div class="bet-item">
                    <div class="bet-info">
                        <h4>${item.nome}</h4>
                        <p>${item.mercado}: ${item.opcao} @ ${item.odd}</p>
                    </div>
                    <button onclick="removerAposta(${index}, ${item.id})" class="bet-delete"><i class="fas fa-trash"></i></button>
                </div>`; 
            });
            
            // Preenche nome se usu√°rio tiver salvo
            if(usuario && usuario.nome) document.getElementById('cliente-nome').value = usuario.nome;
            
            calcularRetorno(); 
            document.getElementById('modal-cupom').classList.remove('hidden');
        }

        function definirValor(val) {
            document.getElementById('valor-aposta').value = val.toFixed(2);
            calcularRetorno();
        }

        function limparCupom() {
            carrinho = [];
            document.querySelectorAll('.odd-active').forEach(btn => btn.classList.remove('odd-active'));
            atualizarBarraCupom();
        }

        function calcularRetorno() {
            const valor = parseFloat(document.getElementById('valor-aposta').value) || 0;
            const oddTotal = carrinho.reduce((acc, item) => acc * parseFloat(item.odd), 1);
            let potencial = valor * oddTotal;
            
            document.getElementById('odd-final').innerText = oddTotal.toFixed(2);
            document.getElementById('retorno-bruto').innerText = `R$ ${potencial.toFixed(2)}`;

            const elementoRetorno = document.getElementById('retorno-liquido');
            if (potencial > LIMITE_GANHO) { 
                potencial = LIMITE_GANHO; 
                elementoRetorno.classList.remove('text-green-500'); 
                elementoRetorno.classList.add('max-win'); 
                document.getElementById('aviso-limite').classList.remove('hidden'); 
            } else { 
                elementoRetorno.classList.remove('max-win'); 
                elementoRetorno.classList.add('text-green-500'); 
                document.getElementById('aviso-limite').classList.add('hidden'); 
            }
            elementoRetorno.innerText = `R$ ${potencial.toFixed(2)}`;
        }

        async function enviarAposta() {
            const SEU_WHATSAPP = "556100000000"; 
            const nomeCliente = document.getElementById('cliente-nome').value;
            const valor = document.getElementById('valor-aposta').value;

            if(!nomeCliente) { alert("Digite seu nome no bilhete!"); return; }
            if(!valor || valor <= 0) { alert("Digite um valor!"); return; }
            if(carrinho.length > LIMITE_JOGOS) return;

            const oddTotal = document.getElementById('odd-final').innerText;
            const retornoPotencial = document.getElementById('retorno-liquido').innerText;

            // Salva nome do cliente para pr√≥ximas vezes
            if(!usuario) {
                usuario = { nome: nomeCliente, saldo: '0.00' };
                localStorage.setItem('gurila_user', JSON.stringify(usuario));
            }

            const res = await fetch(`${API_URL}/api/finalizar`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ usuario_id: 1, valor, apostas: carrinho, odd_total: oddTotal }) }); // ID fixo 1 pra simplificar se n√£o tiver cadastro
            const data = await res.json();
            
            if(data.sucesso) {
                let listaJogos = ""; carrinho.forEach(i => { listaJogos += `‚öΩ ${i.nome}\n   üëâ ${i.mercado}: ${i.opcao} (${i.odd})\n`; });
                const msg = `ü¶ç *GURILA BET - PR√â BILHETE* ü¶ç\n\nüë§ Cliente: *${nomeCliente}*\nüé´ C√≥digo: *${data.codigo}*\nüí∞ Valor: *R$ ${valor}*\nüèÜ Retorno: *${retornoPotencial}*\n\nüìã *PALPITES:*\n${listaJogos}\n_Envie o comprovante para validar!_`;
                window.open(`https://wa.me/${SEU_WHATSAPP}?text=${encodeURIComponent(msg)}`, '_blank');
                limparCupom();
            } else { alert(data.erro); }
        }

        // Validador e Mercados (Mantidos)
        async function validarBilhete() {
            const cod = document.getElementById('input-codigo').value;
            if(!cod) return;
            const res = await fetch(`${API_URL}/api/bilhete/${cod}`);
            const data = await res.json();
            const divRes = document.getElementById('resultado-validacao');
            divRes.classList.remove('hidden');
            if(data.sucesso) { const b = data.bilhete; divRes.innerHTML = `<span class="text-green-500 font-black">‚úÖ V√ÅLIDO</span><br>Cliente: ${b.cliente}<br>Valor: R$ ${b.valor}<br>Retorno: R$ ${b.retorno}<br>Data: ${new Date(b.data).toLocaleString()}`; } 
            else { divRes.innerHTML = `<span class="text-red-500 font-black">‚ùå INV√ÅLIDO</span>`; }
        }

        function abrirMercados(id) {
            const j = todosJogos.find(item => item.id == id);
            if(!j || !j.mercados) return; 
            document.getElementById('modal-titulo').innerText = `${j.home.name} X ${j.away.name}`;
            const m = j.mercados; const nomeJogo = `${j.home.name} x ${j.away.name}`;
            const btn = (merc, sel, odd) => `<div onclick="addAposta(this, ${id}, '${merc}', '${sel}', ${odd}, '${nomeJogo}')" class="market-btn">${sel} <span class="text-green-500">${odd}</span></div>`;
            let html = `
                <div class="market-box"><div class="market-title">Dupla Chance</div><div class="market-grid-3">${btn('Dupla Chance', 'Casa/Empate', m.dupla_chance.casa_empate)} ${btn('Dupla Chance', 'Casa/Fora', m.dupla_chance.casa_fora)} ${btn('Dupla Chance', 'Empate/Fora', m.dupla_chance.empate_fora)}</div></div>
                <div class="market-box"><div class="market-title">Total de Gols</div><div class="market-grid">${btn('Gols', 'Mais 1.5', m.total_gols.mais_15)} ${btn('Gols', 'Menos 1.5', m.total_gols.menos_15)} ${btn('Gols', 'Mais 2.5', m.total_gols.mais_25)} ${btn('Gols', 'Menos 2.5', m.total_gols.menos_25)}</div></div>
                <div class="market-box"><div class="market-title">Ambas Marcam</div><div class="market-grid">${btn('Ambas Marcam', 'Sim', m.ambas_marcam.sim)} ${btn('Ambas Marcam', 'N√£o', m.ambas_marcam.nao)}</div></div>
                <div class="market-box"><div class="market-title">Intervalo / Final</div><div class="market-grid-3">${btn('HT/FT', 'Casa/Casa', m.intervalo_final["Casa/Casa"])} ${btn('HT/FT', 'Empate/Empate', m.intervalo_final["Empate/Empate"])} ${btn('HT/FT', 'Fora/Fora', m.intervalo_final["Fora/Fora"])}</div></div>
                <div class="market-box"><div class="market-title">Placar Exato</div><div class="market-grid-3">${btn('Placar', '1-0', m.placar_exato["1-0"])} ${btn('Placar', '2-0', m.placar_exato["2-0"])} ${btn('Placar', '2-1', m.placar_exato["2-1"])}</div></div>`;
            document.getElementById('modal-corpo').innerHTML = html;
            document.getElementById('modal-extras').classList.remove('hidden');
            document.getElementById('modal-extras').classList.add('flex');
        }

        window.onload = carregar;
    </script>
</body>
</html>
